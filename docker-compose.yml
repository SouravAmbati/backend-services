version: "3.9"

services:
  # ------------------ MONGO REPLICA SET ------------------
  mongo1:
    image: mongo:7
    container_name: mongo1
    command: ["--replSet", "rs0", "--bind_ip_all"]
    volumes:
      - mongo1-data:/data/db
    networks:
      - backend

  mongo2:
    image: mongo:7
    container_name: mongo2
    command: ["--replSet", "rs0", "--bind_ip_all"]
    volumes:
      - mongo2-data:/data/db
    networks:
      - backend

  mongo3:
    image: mongo:7
    container_name: mongo3
    command: ["--replSet", "rs0", "--bind_ip_all"]
    volumes:
      - mongo3-data:/data/db
    networks:
      - backend

  # Init replica set
  mongo-init:
    image: mongo:7
    container_name: mongo-init
    depends_on:
      - mongo1
      - mongo2
      - mongo3
    entrypoint: >
      bash -c "
        sleep 20 &&
        mongosh --host mongo1:27017 --eval '
          rs.initiate({
            _id: \"rs0\",
            members: [
              { _id: 0, host: \"mongo1:27017\" },
              { _id: 1, host: \"mongo2:27017\" },
              { _id: 2, host: \"mongo3:27017\" }
            ]
          })
        '
      "
    networks:
      - backend

  # ------------------ REDIS ------------------
  redis:
    image: redis:7
    container_name: redis
    networks:
      - backend
    volumes:
      - redis-data:/data

  # ------------------ AUTH SERVICE ------------------
  auth:
    build: ./auth-service
    container_name: auth-service
    environment:
      - PORT=5001
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/auth?replicaSet=rs0
      - ADMIN_SECRET=supersecret123
      - ADMIN_PASSWORD=qwerty12
      - ADMIN_EMAIL=admin@forever.com
      - JWT_SECRET=forever
      
    networks:
      - backend
    expose:
      - "5001"

  # ------------------ PRODUCT SERVICE ------------------
  product:
    build: ./product-service
    container_name: product-service
    environment:
      - PORT=5002
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/product?replicaSet=rs0
      - CLOUDINARY_CLOUD_NAME=ddcapbonv
      - CLOUDINARY_API_KEY=193935646561233
      - CLOUDINARY_API_SECRET=5kX6R6KqGZTQmtKaeN52GISh_sg
      - REDIS_URL=redis://default:password@redis:6379
      - JWT_SECRET=forever
      - ADMIN_SECRET=supersecret123
      - ADMIN_PASSWORD=qwerty12
      - ADMIN_EMAIL=admin@forever.com
    depends_on:
      - redis
    networks:
      - backend
    expose:
      - "5002"
    volumes:
      - ./product-service/uploads:/app/uploads 

  # ------------------ CART SERVICE ------------------
  cart:
    build: ./cart-service
    container_name: cart-service
    environment:
      - PORT=5003
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/auth?replicaSet=rs0
      - JWT_SECRET=forever
      - REDIS_URL=redis://default:password@redis:6379
    depends_on:
      - redis
    networks:
      - backend
    expose:
      - "5003"

  # ------------------ ORDER SERVICE ------------------
  order:
    build: ./order-service
    container_name: order-service
    environment:
      - PORT=5004
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/order?replicaSet=rs0
      - JWT_SECRET=forever
      - STRIPE_SECRET_KEY=sk_test_51QdpKnFj7XmjtqXtQUoXMHgPSqLbgFmtCqj76af2UvIFr7gMuNBI8zkjArrwMidGOZvMOBy5f3384HfaAGJeVuuJ00eld9fUE9
      - REDIS_URL=redis://default:password@redis:6379
    depends_on:
      - redis
    networks:
      - backend
    expose:
      - "5004"

  # ------------------ NGINX API GATEWAY ------------------
  nginx:
    image: nginx:stable
    container_name: mfe-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
    depends_on:
      - auth
      - product
      - order
      - cart
    networks:
      - backend
    entrypoint: >
      sh -c "sleep 15 && nginx -g 'daemon off;'"

# ------------------ NETWORKS ------------------
networks:
  backend:

# ------------------ VOLUMES ------------------
volumes:
  redis-data:
  mongo1-data:
  mongo2-data:
  mongo3-data:
